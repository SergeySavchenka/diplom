{% extends "base.html" %}

{% block title %}–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á{% endblock %}

{% block content %}
<div class="p-4">
    <h2 class="mb-4">üß© –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h2>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <table class="table table-hover align-middle" id="tasksTable">
        <thead class="table-light">
            <tr>
                <!-- ID -->
                <th scope="col">
                    ID
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm mt-2" data-column="0" placeholder="–ü–æ–∏—Å–∫">
                        <i class="bi bi-filter-left sort-icon ms-2" style="cursor: pointer;" data-column="0"></i>
                    </div>
                </th>

                <!-- –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ -->
                <th scope="col">
                    –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm mt-2" data-column="1" placeholder="–ü–æ–∏—Å–∫">
                        <i class="bi bi-filter-left sort-icon ms-2" style="cursor: pointer;" data-column="1"></i>
                    </div>
                </th>

                <!-- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
                <th scope="col">
                    –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm mt-2" data-column="2" placeholder="–ü–æ–∏—Å–∫">
                        <i class="bi bi-filter-left sort-icon ms-2" style="cursor: pointer;" data-column="2"></i>
                    </div>
                </th>

                <!-- –°—Ç–∞—Ç—É—Å -->
                <th scope="col">
                    –°—Ç–∞—Ç—É—Å
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm mt-2" data-column="3" placeholder="–ü–æ–∏—Å–∫">
                        <i class="bi bi-filter-left sort-icon ms-2" style="cursor: pointer;" data-column="3"></i>
                    </div>
                </th>

                <!-- –õ–µ–π–±–ª—ã -->
                <th scope="col">
                    –õ–µ–π–±–ª—ã
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm mt-2" data-column="4" placeholder="–ü–æ–∏—Å–∫">
                        <i class="bi bi-filter-left sort-icon ms-2" style="cursor: pointer;" data-column="4"></i>
                    </div>
                </th>

                <!-- –í–µ—Å -->
                <th scope="col">
                    –í–µ—Å
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm mt-2" data-column="5" placeholder="–ü–æ–∏—Å–∫">
                        <i class="bi bi-filter-left sort-icon ms-2" style="cursor: pointer;" data-column="5"></i>
                    </div>
                </th>

                <!-- –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è -->
                <th scope="col">
                    –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    <div class="d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control form-control-sm mt-2" data-column="6" placeholder="–ü–æ–∏—Å–∫">
                        <i class="bi bi-filter-left sort-icon ms-2" style="cursor: pointer;" data-column="6"></i>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
                <tr ondblclick="window.location.href='/task/{{ task.id }}'" style="cursor: pointer;">
                    <td>{{ task.id }}</td>
                    <td class="col-title" style="max-width: 250px;">
                        {% set title = task.title %}
                        {% if title | length > 40 %}
                            <span class="d-inline-block text-truncate" style="max-width: 100%;" data-bs-toggle="tooltip" title="{{ title }}">
                                {{ title[:40] }}...
                            </span>
                        {% else %}
                            {{ title }}
                        {% endif %}
                    </td>
                    <td>{{ task.created_at.strftime('%d.%m.%Y') if task.created_at else '‚Äî' }}</td>
                    <td>
                        {% if task.status_id != 5 %}
                            <span class="badge bg-success">–û—Ç–∫—Ä—ã—Ç–∞</span>
                        {% else %}
                            <span class="badge bg-secondary">–ó–∞–∫—Ä—ã—Ç–∞</span>
                        {% endif %}
                    </td>
                    <td class="col-labels" style="max-width: 150px;">
                        {% if task.labels %}
                            {% set labels = task.labels %}
                            {% set limit = 2 %}

                            <div class="label-badges">
                                {% for label in labels[:limit] %}
                                    <span class="badge text-black me-1 mb-1" style="background-color: {{ label.color }};">
                                        {{ label.name }}
                                    </span>
                                {% endfor %}

                                {% if labels | length > limit %}
                                    <span class="badge bg-secondary text-white ms-1 mb-1" data-bs-toggle="tooltip"
                                          title="{% for label in labels[limit:] %}{{ label.name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                        +{{ (labels | length) - limit }}
                                    </span>
                                {% endif %}
                            </div>
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>{{ task.weight if task.weight else '‚Äî' }}</td>
                    <td>{{ task.updated_at.strftime('%d.%m.%Y') if task.updated_at else '‚Äî' }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- JS –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInputs = document.querySelectorAll("#tasksTable thead input");
    const sortableHeaders = document.querySelectorAll(".sort-icon");
    let currentSortedColumn = null;
    let currentOrder = null;

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function sortTable(columnIndex, order) {
        const tbody = document.querySelector("#tasksTable tbody");
        const rows = Array.from(document.querySelectorAll("#tasksTable tbody tr"));

        rows.sort((a, b) => {
            let cellA = a.cells[columnIndex].innerText.trim().toLowerCase();
            let cellB = b.cells[columnIndex].innerText.trim().toLowerCase();

            // –ß–∏—Å–ª–∞
            if (!isNaN(cellA) && !isNaN(cellB)) {
                return order === "asc" ? cellA - cellB : cellB - cellA;
            }

            // –î–∞—Ç—ã dd.mm.yyyy
            const dateRegex = /^\d{2}\.\d{2}\.\d{4}$/;
            if (dateRegex.test(cellA) && dateRegex.test(cellB)) {
                const dateA = new Date(cellA.split('.').reverse().join('-'));
                const dateB = new Date(cellB.split('.').reverse().join('-'));
                return order === "asc" ? dateA - dateB : dateB - dateA;
            }

            // –°—Ç—Ä–æ–∫–∏
            return order === "asc" ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∏–∫–æ–Ω–∫–∞–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    sortableHeaders.forEach(icon => {
        icon.addEventListener("click", function () {
            const columnIndex = parseInt(this.getAttribute("data-column"));
            const currentIcon = this;

            if (currentSortedColumn !== null && currentSortedColumn !== columnIndex) {
                // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const prevIcon = document.querySelector(`.sort-icon[data-column='${currentSortedColumn}']`);
                if (prevIcon) {
                    prevIcon.classList.remove("bi-arrow-up", "bi-arrow-down");
                    prevIcon.classList.add("bi-filter-left");
                }
            }

            let newOrder;
            if (currentSortedColumn === columnIndex) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                if (currentOrder === "asc") {
                    newOrder = "desc";
                    currentIcon.classList.remove("bi-filter-left", "bi-arrow-up");
                    currentIcon.classList.add("bi-arrow-down");
                } else if (currentOrder === "desc") {
                    newOrder = null;
                    currentIcon.classList.remove("bi-arrow-down", "bi-arrow-up");
                    currentIcon.classList.add("bi-filter-left");
                } else {
                    newOrder = "asc";
                    currentIcon.classList.remove("bi-filter-left");
                    currentIcon.classList.add("bi-arrow-up");
                }
            } else {
                newOrder = "asc";
                currentIcon.classList.remove("bi-filter-left");
                currentIcon.classList.add("bi-arrow-up");
            }

            currentSortedColumn = newOrder !== null ? columnIndex : null;
            currentOrder = newOrder;

            if (newOrder !== null) {
                sortTable(columnIndex, newOrder);
            } else {
                // –°–±—Ä–æ—Å –¥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
                const tbody = document.querySelector("#tasksTable tbody");
                const rows = Array.from(document.querySelectorAll("#tasksTable tbody tr")).sort(
                    (a, b) => a.dataset.originalIndex - b.dataset.originalIndex
                );
                tbody.innerHTML = "";
                rows.forEach(row => tbody.appendChild(row));
            }
        });
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å—Ç—Ä–æ–∫
    document.querySelectorAll("#tasksTable tbody tr").forEach((row, index) => {
        row.dataset.originalIndex = index;
    });

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    function applyFilters() {
        const rows = document.querySelectorAll("#tasksTable tbody tr");
        const filters = Array.from(searchInputs).map(input => ({
            column: parseInt(input.getAttribute("data-column")),
            value: input.value.toLowerCase()
        }));

        rows.forEach(row => {
            let show = true;

            filters.forEach(filter => {
                const cellText = row.cells[filter.column]?.innerText.toLowerCase();
                if (filter.value && cellText && !cellText.includes(filter.value)) {
                    show = false;
                }
            });

            row.style.display = show ? "" : "none";
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –ø–æ–∏—Å–∫–∞
    searchInputs.forEach(input => {
        input.addEventListener("input", function () {
            applyFilters();
        });
    });

    applyFilters();
});
</script>
<style>
    /* –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª—è —Ç–∞–±–ª–∏—Ü—ã */
#tasksTable {
    border-collapse: collapse; /* –û–±—ä–µ–¥–∏–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —è—á–µ–µ–∫ */
}

#tasksTable th,
#tasksTable td {
    border: 1px solid #dee2e6; /* –ì—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —è—á–µ–π–∫–∞–º–∏ */
    padding: 0.5rem; /* –ü–∞–¥–¥–∏–Ω–≥ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–µ–∫ */
    vertical-align: middle; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
}

#tasksTable thead th {
    background-color: #f8f9fa; /* –¢—ë–º–Ω—ã–π —Ñ–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
    font-weight: bold; /* –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
}

#tasksTable tbody tr:hover {
    background-color: #e9ecef; /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
}
</style>
{% endblock %}
